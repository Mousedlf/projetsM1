{% extends 'base.html.twig' %}

{% block title %}Hello ProjectController!{% endblock %}

{% block body %}

    <h1>tous les projets</h1>
    {% if app.user %}
    <a href="{{ path('new_project') }}">new</a>
        {% else %}
        <p>connecte toi pour ajouter un produit ou indiquer lequel t'interresse</p>
            <a href="{{ path('app_login') }}" class=" ">Login</a>

    {% endif %}

    {# Message flash #}
    {% for message in app.flashes('notice') %}
        <div class="flash-notice alert alert-warning alert-dismissible fade show" role="alert">
            <p class="mb-0">{{ message }}</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

<div class="row">
    {% for project in projects %}
        <div class="col-6">
            <div class="card mb-4 p-3">
                {% for image in project.images %}
                    <img src="{{ vich_uploader_asset(image, 'imageFile') }}"  alt="">

                {% endfor %}
                <a href="{{ path('show_project', {id:project.id}) }}" class="mt-2 btn btn-primary">see more</a>

{% if app.user %}
                <p><strong>
                        <a href="{{ path('app_like', {id:project.id}) }}" class="btn like">
                            <i class="thumb bi bi-hand-thumbs-up{% if project.isLikedBy(app.user) %}-fill{% endif %}"></i>
                            <span class="nbLikes">{{ project.likes|length}}</span>
                        </a>

                    </strong></p>
                {% endif %}

                {#            {% if project.images.0 is not null %}
                    <img src="{{ vich_uploader_asset(project.images.0, 'imageFile') }}"  alt="">
            {% endif %}#}
                {#<h2>{{ project.name }}</h2>
                <p>{{ project.description }}</p>#}
                {% if app.user == project.author %}
                    <a href="{{ path('edit_project', {id:project.id}) }}" class="btn btn-warning">edit</a>
                    <a href="{{ path('app_image', {id:project.id}) }}" class="btn btn-success">ajouter et enlever des images</a>
                    <form method="post" action="{{ path('delete_project', {'id': project.id}) }}" onsubmit="return confirm('Are you sure you want to delete this item?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ project.id) }}">
                        <button class="btn btn-outline-danger">Delete</button>
                    </form>
                {% endif %}
            </div>

        </div>
    {% endfor %}

</div>



    <script>

        function like(event){
            event.preventDefault()

            fetch(this.href)
                .then(response=>response.json())
                .then((data)=>{
                    this.querySelector('.nbLikes').innerHTML = data.count
                    if(data.liked){
                        this.querySelector('.thumb').classList.remove('bi-hand-thumbs-up')
                        this.querySelector('.thumb').classList.add('bi-hand-thumbs-up-fill')
                    }else{
                        this.querySelector('.thumb').classList.remove('bi-hand-thumbs-up-fill')
                        this.querySelector('.thumb').classList.add('bi-hand-thumbs-up')
                    }
                })
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            const boutonsLike = document.querySelectorAll('.like')

            boutonsLike.forEach((bouton)=>{
                bouton.addEventListener('click', like)
            })
        })

    </script>


{% endblock %}
